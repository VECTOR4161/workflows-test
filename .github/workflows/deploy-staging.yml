name: Deploy to Staging

on:
  workflow_run:
    workflows: ["Build & Release"]
    types: [completed]
    branches: [main, feature/productos-crud]
  workflow_dispatch:
    inputs:
      release_tag:
        description: "Release tag to deploy"
        required: true

concurrency:
  group: deploy-staging
  cancel-in-progress: false

env:
  ENVIRONMENT: staging
  HEALTH_CHECK_TIMEOUT: 30
  # Define aqu√≠ la ruta de tu app para no repetirla
  STAGING_PATH: "/var/www/sistema-ventas" 

jobs:
  deploy:
    name: Deploy to Staging
    # CAMBIO 1: Usar tu propio servidor
    runs-on: self-hosted
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'feature/productos-crud')
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Get Release Tag
        id: release
        run: |
          if [ -n "${{ github.event.inputs.release_tag }}" ]; then
            RELEASE_TAG="${{ github.event.inputs.release_tag }}"
          else
            RELEASE_TAG=$(gh release list --limit 10 | grep -E 'feature/productos-crud' | head -1 | awk '{print $1}' || echo "")
            if [ -z "$RELEASE_TAG" ]; then
              echo "No release found"
              exit 1
            fi
          fi
          echo "release_tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # CAMBIO 2: Los Pre-checks ahora son comandos directos
      - name: Pre-Deploy Checks
        run: |
          set -e
          echo "üîç Running pre-deploy checks..."
          AVAILABLE=$(df -BG ${{ env.STAGING_PATH }} | awk 'NR==2 {print $4}' | sed 's/G//')
          if [ "$AVAILABLE" -lt 2 ]; then exit 1; fi
          [ -d "${{ env.STAGING_PATH }}/shared" ] || exit 1
          [ -f "${{ env.STAGING_PATH }}/shared/.env" ] || exit 1
          echo "‚úÖ All checks passed"

      # CAMBIO 3: Despliegue directo (sin SSH)
      - name: Deploy Application
        run: |
          set -e
          cd ${{ env.STAGING_PATH }}
          RELEASE_TAG="${{ steps.release.outputs.release_tag }}"
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          RELEASE_DIR="releases/${TIMESTAMP}"

          echo "üì¶ Downloading and extracting release..."
          ARTIFACT_NAME="sistema-ventas-${RELEASE_TAG}"
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${RELEASE_TAG}/${ARTIFACT_NAME}.tar.gz"
          
          mkdir -p "/tmp/deploy-${TIMESTAMP}"
          curl -fsSL -o "/tmp/deploy-${TIMESTAMP}/${ARTIFACT_NAME}.tar.gz" "$DOWNLOAD_URL"
          mkdir -p "${RELEASE_DIR}"
          tar -xzf "/tmp/deploy-${TIMESTAMP}/${ARTIFACT_NAME}.tar.gz" -C "${RELEASE_DIR}"

          echo "üîó Symlinks & Permissions..."
          rm -rf "${RELEASE_DIR}/storage"
          ln -sfn "$(pwd)/shared/storage" "${RELEASE_DIR}/storage"
          ln -sfn "$(pwd)/shared/.env" "${RELEASE_DIR}/.env"
          
          # Nota: El runner debe tener permisos de sudo para estas l√≠neas
          sudo chown -R www-data:www-data "${RELEASE_DIR}"
          
          echo "üîÑ Migrations & Switch..."
          cd "${RELEASE_DIR}"
          php artisan migrate --force
          
          cd ${{ env.STAGING_PATH }}
          ln -sfn "$(pwd)/${RELEASE_DIR}" current.new
          mv -Tf current.new current

          echo "üîÉ Reloading services..."
          sudo systemctl reload php8.4-fpm || sudo systemctl reload php8.2-fpm || true
          sudo nginx -s reload || true

      - name: Health Check
        run: |
          # El health check se puede hacer contra localhost ya que est√°s dentro
          curl -f http://localhost/api/health || exit 1

      # CAMBIO 4: Rollback simplificado
      - name: Rollback on Failure
        if: failure()
        run: |
          cd ${{ env.STAGING_PATH }}
          PREVIOUS=$(ls -t releases | sed -n '2p')
          if [ -n "$PREVIOUS" ]; then
            ln -sfn "$(pwd)/releases/${PREVIOUS}" current.new
            mv -Tf current.new current
            sudo systemctl reload php8.4-fpm || true
          fi